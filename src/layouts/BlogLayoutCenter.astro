---
import { type CollectionEntry } from "astro:content";
import { Image } from "astro:assets";

// main layout
import BaseLayout from "./BaseLayout.astro";

// components
import Button from "@components/Button/Button.astro";

// utils
import { formatDate, humanize, slugify } from "@js/textUtils";
import { getAllAuthorsData, isDevMode } from "@js/blogUtils";

interface Props {
    post: CollectionEntry<"blog">;
}

const { post } = Astro.props as Props;
const {
    title,
    description,
    authors,
    categories,
    pubDate,
    updatedDate,
    heroImage,
    canonicalUrl,
} = post.data;

// Extract domain from canonical URL for display
function getSourceName(url: string): string {
    try {
        const hostname = new URL(url).hostname.replace("www.", "");
        // Map common domains to friendly names
        const domainMap: Record<string, string> = {
            "starburst.io": "Starburst",
            "medium.com": "Medium",
            "dev.to": "DEV",
            "trino.io": "Trino",
            "getdbt.com": "dbt",
        };
        return domainMap[hostname] || hostname;
    } catch {
        return url;
    }
}

const authorsData = await getAllAuthorsData(authors);

const isDraft = post.data.draft === true;
const showDraftBanner = isDraft && isDevMode();
---

<BaseLayout
    type="blog"
    title={title}
    description={description}
    image={heroImage}
    authorsData={authorsData}
    postFrontmatter={post.data}
>
    {showDraftBanner && (
        <div class="fixed left-0 right-0 top-0 z-50 bg-amber-400 px-4 py-2 text-center text-sm font-medium text-amber-900">
            This is a draft post &mdash; only visible in development mode
        </div>
    )}
    <article class={`container pt-36 md:pt-44 ${showDraftBanner ? 'mt-10' : ''}`}>
        <!-- Blog post info -->
        <div class="flex w-full flex-col items-center">
            <div class="mx-auto flex w-full max-w-[900px]">
                <div class="mx-auto text-center">
                    <!-- Categories -->
                    <div class="flex justify-center gap-3">
                        {
                            categories.map((category) => (
                                <a
                                    href={`/categories/${slugify(category)}/`}
                                    class="button button--ghost px-3 py-1 text-xs font-medium md:px-4 md:py-1.5 md:text-sm"
                                >
                                    {humanize(category)}
                                </a>
                            ))
                        }
                    </div>

                    <!-- title -->
                    <h1 class="h1 mt-8 leading-tight">{title}</h1>

                    <div
                        class="mt-8 flex w-full flex-wrap items-center justify-center gap-3 text-sm"
                    >
                        <!-- author info -->
                        {
                            authorsData.map((authorData) => (
                                <div class="flex items-center gap-2">
                                    <figure>
                                        <Image
                                            src={authorData.data.avatar}
                                            alt={`${authorData.data.name} avatar`}
                                            width={100}
                                            quality="high"
                                            class="h-8 w-8 rounded-full object-cover ring-2 ring-primary-100"
                                        />
                                    </figure>
                                    <div class="font-medium">
                                        {authorData.data.name}
                                    </div>
                                </div>
                            ))
                        }

                        <span class="opacity-50">&bull;</span>

                        <!-- Date -->
                        <time
                            class="opacity-70"
                            datetime={pubDate.toISOString()}
                            >{formatDate(pubDate)}
                        </time>
                    </div>
                </div>
            </div>

            <!-- blog post main image -->
            <div class="mt-10 max-w-[1100px] overflow-hidden md:mt-12">
                <Image
                    src={heroImage}
                    alt={`Cover for ${title}`}
                    width={2000}
                    quality="high"
                    class="max-h-[65vh] w-full rounded-2xl object-cover shadow-lg"
                    loading="eager"
                    format="webp"
                />
            </div>
        </div>

        <!-- article content -->
        <div class="mt-14 w-full md:mt-16">
            <div class="mx-auto max-w-3xl">
                <div class="text-base-content">
                    {
                        canonicalUrl && (
                            <div class="mb-8 rounded-lg border border-primary-200 bg-primary-50 px-4 py-3 text-sm">
                                Originally published on{" "}
                                <a
                                    href={canonicalUrl}
                                    class="font-medium text-primary-700 underline hover:text-primary-900"
                                    target="_blank"
                                    rel="noopener"
                                >
                                    {getSourceName(canonicalUrl)}
                                </a>
                            </div>
                        )
                    }
                    {
                        updatedDate && (
                            <div class="mb-8 rounded-lg bg-base-200 px-4 py-3 text-sm italic opacity-80">
                                <time datetime={updatedDate.toISOString()}>
                                    Last updated: {formatDate(updatedDate)}
                                </time>
                            </div>
                        )
                    }
                    <section
                        id="blog-post-content"
                        class="prose prose-lg mx-auto max-w-none"
                    >
                        <slot />
                    </section>

                    <!-- button to go back to all posts -->
                    <div class="mt-20 flex justify-center border-t border-base-300 pt-12">
                        <Button
                            variant="outline"
                            href="/blog/"
                            arrow="left"
                            class="py-2"
                        >
                            Back to all posts
                        </Button>
                    </div>
                </div>
            </div>
        </div>
    </article>
</BaseLayout>
